{% extends "base.html" %}

{% block title %}Expenses - Split App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-receipt me-2"></i>Expense Management
        </h1>
    </div>
</div>

<!-- Add Expense Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>Add New Expense
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('web.add_expense') }}" id="expenseForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount ($) *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="amount" name="amount" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="description" class="form-label">Description *</label>
                                <input type="text" class="form-control" id="description" name="description" required placeholder="e.g., Dinner at restaurant">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="paid_by" class="form-label">Paid By *</label>
                                <input type="text" class="form-control" id="paid_by" name="paid_by" required placeholder="Person's name" list="peopleList">
                                <datalist id="peopleList">
                                    {% for person in people %}
                                        <option value="{{ person.name }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                        </div>
                    </div>
                    
                    {% if people %}
                    <div class="mb-3">
                        <label class="form-label">Split Among (default: all people)</label>
                        <div class="row">
                            {% for person in people %}
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="participants" value="{{ person.name }}" id="participant_{{ person.id }}" checked>
                                        <label class="form-check-label" for="participant_{{ person.id }}">
                                            {{ person.name }}
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">Select who should share this expense (equal split)</small>
                    </div>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Expense
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Expenses List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>All Expenses
                </h5>
                <span class="badge bg-secondary">{{ expenses|length }} expenses</span>
            </div>
            <div class="card-body">
                {% if expenses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Paid By</th>
                                    <th>Split Method</th>
                                    <th>Participants</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                    <tr>
                                        <td>
                                            <small>{{ expense.created_at.strftime('%m/%d/%Y') if expense.created_at else 'N/A' }}</small>
                                        </td>
                                        <td>
                                            <strong>{{ expense.description }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">${{ "%.2f"|format(expense.amount) }}</span>
                                        </td>
                                        <td>{{ expense.payer.name }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ expense.split_method.value|title }}</span>
                                        </td>
                                        <td>
                                            <small>
                                                {% for split in expense.splits %}
                                                    {{ split.person.name }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                        </td>
                                        <td>
                                            <form method="POST" action="{{ url_for('web.delete_expense', expense_id=expense.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this expense?')">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-4x mb-3"></i>
                        <h4>No Expenses Yet</h4>
                        <p>Start by adding your first expense using the form above.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- API Testing Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-code me-2"></i>API Testing
                </h5>
            </div>
            <div class="card-body">
                <p>Test the API endpoints directly:</p>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-primary" onclick="testAPI('GET', '/api/expenses')">
                        GET Expenses
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="testAPI('GET', '/api/people')">
                        GET People
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="testAPI('GET', '/api/balances')">
                        GET Balances
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="testAPI('GET', '/api/settlements')">
                        GET Settlements
                    </button>
                </div>
                <div id="apiResult" class="mt-3" style="display: none;">
                    <h6>API Response:</h6>
                    <pre class="bg-dark text-light p-3 rounded"></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-check the payer in participants when paid_by changes
document.getElementById('paid_by').addEventListener('input', function() {
    const paidBy = this.value.trim();
    const checkboxes = document.querySelectorAll('input[name="participants"]');
    
    // Uncheck all first
    checkboxes.forEach(cb => cb.checked = false);
    
    // Check the one that matches paid_by
    checkboxes.forEach(cb => {
        if (cb.value === paidBy) {
            cb.checked = true;
        }
    });
    
    // If no match found, check all (default behavior)
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
    if (!anyChecked) {
        checkboxes.forEach(cb => cb.checked = true);
    }
});

// API Testing function
async function testAPI(method, endpoint) {
    const resultDiv = document.getElementById('apiResult');
    const preElement = resultDiv.querySelector('pre');
    
    try {
        const response = await fetch(endpoint, { method: method });
        const data = await response.json();
        
        preElement.textContent = JSON.stringify(data, null, 2);
        resultDiv.style.display = 'block';
    } catch (error) {
        preElement.textContent = 'Error: ' + error.message;
        resultDiv.style.display = 'block';
    }
}
</script>
{% endblock %}
